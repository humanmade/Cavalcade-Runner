#!/usr/bin/env php
<?php

namespace HM\Cavalcade\Runner;

use Exception;

include dirname(__DIR__) . '/bootstrap.php';

$options = getopt('l:p:b:w:c:');
$log_path = $options['l'] ?? '/var/log/wp/cron.log';
$pid_file = $options['p'] ?? '/run/cavalcade/cavalcade.pid';
$wp_base_path = $options['b'] ?? '/var/web/wp';
$max_workers_count = $options['w'] ?? 2;
$wpcli_path = $options['c'] ?? '/usr/local/bin/wp';

date_default_timezone_set('UTC');
$log = Logger::create($log_path);
$pid = getmypid();
if ($pid === null) {
    $log->fatal('cannot get PID');
    exit(1);
}

file_put_contents($pid_file, $pid);

try {
    $runner = Runner::instance($log, $max_workers_count, $wpcli_path);
    $runner->bootstrap($wp_base_path);
    $log->info('Cavalcade Runner started');
    $runner->run();
} catch (SignalInterrupt $e) {
    $log->info('shutting down', [
        'reason' => $e->getMessage(),
        'signal' => $e->getCode(),
    ]);
} catch (Exception $e) {
    $log->fatal($e->getMessage(), ['trace' => $e->getTraceAsString()]);
    unlink($pid_file);
    exit(1);
} finally {
    unlink($pid_file);
}
